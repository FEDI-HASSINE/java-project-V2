<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Espace Chef Général - Maquette</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #070a18;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.12);
      --accent: #22d3ee;
      --accent-2: #f472b6;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --success: #34d399;
      --danger: #f87171;
      --warn: #fbbf24;
      --radius: 14px;
      --shadow: 0 20px 80px rgba(0,0,0,0.45);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Space Grotesk', 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 18% 24%, rgba(34,211,238,0.16), transparent 34%),
                  radial-gradient(circle at 82% 12%, rgba(244,114,182,0.20), transparent 36%),
                  linear-gradient(135deg, #0b1024, #070a18);
      color: var(--text);
      padding: 26px;
    }

    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; gap: 12px; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: -0.2px; }
    .brand-dot { width: 11px; height: 11px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: 0 0 18px rgba(34,211,238,0.45); }

    .layout { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .panel { background: var(--panel); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); backdrop-filter: blur(12px); }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; color: var(--muted); font-size: 12px; letter-spacing: 0.35px; text-transform: uppercase; }

    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px; }
    .kpi-card { background: var(--panel); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; box-shadow: var(--shadow); display: grid; gap: 6px; }
    .kpi-label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; }
    .kpi-value { font-size: 24px; font-weight: 700; }
    .kpi-trend { font-size: 12px; color: var(--success); }

    .list { display: flex; flex-direction: column; gap: 10px; }
    .card-item { padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); background: var(--panel-strong); display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .title { font-weight: 600; letter-spacing: 0.1px; }
    .meta { color: var(--muted); font-size: 13px; }

    .badge { padding: 6px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); font-size: 12px; letter-spacing: 0.2px; white-space: nowrap; }
    .badge-ok { color: var(--success); border-color: rgba(52,211,153,0.3); }
    .badge-warn { color: var(--warn); border-color: rgba(251,191,36,0.3); }
    .badge-danger { color: var(--danger); border-color: rgba(248,113,113,0.35); }

    .progress-track { height: 8px; border-radius: 999px; background: rgba(255,255,255,0.08); overflow: hidden; }
    .progress-bar { height: 100%; border-radius: 999px; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }

    .two-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
    .row-between { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .empty { color: var(--muted); font-size: 13px; text-align: center; padding: 18px 0; }

    .tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px; }
    .tab-btn { padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: var(--panel); color: var(--text); cursor: pointer; font-weight: 600; }
    .tab-btn.active { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(34,211,238,0.35); background: linear-gradient(120deg, rgba(34,211,238,0.15), rgba(244,114,182,0.1)); }

    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useMemo, useState, useEffect } = React;

    function getApiBase() {
        const host = window.location.hostname;
        const isLocal = host === 'localhost' || host === '127.0.0.1' || host === '0.0.0.0';
        if (isLocal) {
            return 'http://localhost:8080';
        }
        const proto = window.location.protocol === 'https:' ? 'https' : 'http';
        return `${proto}://${host.replace('-8000', '-8080')}`;
    }

    function parseJwt(token) {
        try {
          const base64Url = token.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
    }

    function Progress({ value }) {
      const pct = Math.min(100, Math.max(0, value));
      return (
        <div className="progress-track">
          <div className="progress-bar" style={{ width: pct + '%' }}></div>
        </div>
      );
    }

    function BadgeEtat({ value }) {
      if (value >= 100) return <span className="badge badge-ok">Terminé</span>;
      if (value >= 60) return <span className="badge badge-warn">En cours</span>;
      return <span className="badge badge-danger">À démarrer</span>;
    }

    function App() {
      const [token, setToken] = useState(sessionStorage.getItem('municipaliteToken') || localStorage.getItem('municipaliteToken') || '');
      const [activeSection, setActiveSection] = useState('interventions');
      
      const [agents, setAgents] = useState([]);
      const [interventions, setInterventions] = useState([]);
      const [rapports, setRapports] = useState([]);
      const [equipements, setEquipements] = useState([]);
      const [citoyens, setCitoyens] = useState([]);

      const [selectedIntervention, setSelectedIntervention] = useState(null);
      const [selectedRapport, setSelectedRapport] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const API = getApiBase();

      useEffect(() => {
        if (!token) {
          window.location.href = 'login.html';
          return;
        }
        const decoded = parseJwt(token);
        if (!decoded || decoded.role !== 'chef') {
             // Optional: redirect if not chef, but for now just load data
        }
        loadAllData();
      }, [token]);

      async function loadAllData() {
          setLoading(true);
          try {
              const headers = { 'Authorization': `Bearer ${token}` };
              
              const [resAgents, resInterv, resRapports, resEquip, resCitoyens] = await Promise.all([
                  fetch(`${API}/agents`, { headers }),
                  fetch(`${API}/interventions`, { headers }),
                  fetch(`${API}/rapports`, { headers }),
                  fetch(`${API}/equipements`, { headers }),
                  fetch(`${API}/citoyens`, { headers })
              ]);

              if (resAgents.ok) setAgents(await resAgents.json());
              if (resInterv.ok) setInterventions(await resInterv.json());
              if (resRapports.ok) setRapports(await resRapports.json());
              if (resEquip.ok) setEquipements(await resEquip.json());
              if (resCitoyens.ok) setCitoyens(await resCitoyens.json());

          } catch (e) {
              console.error(e);
              setError("Erreur lors du chargement des données.");
          } finally {
              setLoading(false);
          }
      }

      const kpis = useMemo(() => {
        const totalInterv = interventions.length;
        const done = interventions.filter(i => i.etat >= 100).length;
        const enCours = interventions.filter(i => i.etat > 0 && i.etat < 100).length;
        const nonDemarre = interventions.filter(i => i.etat === 0).length;
        const dispoAgents = agents.filter(a => a.disponibilite).length;
        const urgenceMoy = interventions.length ? (interventions.reduce((s, i) => s + i.urgence, 0) / interventions.length).toFixed(1) : '0';
        const equipDispo = equipements.filter(e => e.disponible).length;
        const coutTotal = rapports.reduce((s, r) => s + r.cout, 0);
        return {
          totalInterv,
          done,
          enCours,
          nonDemarre,
          dispoAgents,
          urgenceMoy,
          equipDispo,
          coutTotal
        };
      }, [interventions, agents, equipements, rapports]);

      return (
        <div>
          <header>
            <div className="brand"><span className="brand-dot"></span> Espace Chef Général</div>
            <div style={{ color: 'var(--muted)', fontSize: 13 }}>Vue globale: agents · interventions · rapports · équipements</div>
          </header>

          {error && <div style={{color: 'var(--danger)', marginBottom: 10}}>{error}</div>}
          {loading && <div style={{color: 'var(--accent)', marginBottom: 10}}>Chargement des données...</div>}

          <div className="kpi-grid">
            <div className="kpi-card">
              <div className="kpi-label">Interventions</div>
              <div className="row-between">
                <div className="kpi-value">{kpis.totalInterv}</div>
                <div className="kpi-trend">{kpis.done} terminées</div>
              </div>
              <Progress value={(kpis.done / Math.max(1, kpis.totalInterv)) * 100} />
            </div>
            <div className="kpi-card">
              <div className="kpi-label">En cours</div>
              <div className="row-between">
                <div className="kpi-value">{kpis.enCours}</div>
                <div className="badge badge-warn">Urgence moyenne {kpis.urgenceMoy}/5</div>
              </div>
            </div>
            <div className="kpi-card">
              <div className="kpi-label">Agents disponibles</div>
              <div className="row-between">
                <div className="kpi-value">{kpis.dispoAgents}</div>
                <div className="badge badge-ok">Sur {agents.length}</div>
              </div>
            </div>
            <div className="kpi-card">
              <div className="kpi-label">Équipements libres</div>
              <div className="row-between">
                <div className="kpi-value">{kpis.equipDispo}</div>
                <div className="badge badge-ok">Total {equipements.length}</div>
              </div>
            </div>
            <div className="kpi-card">
              <div className="kpi-label">Coût cumulé rapports</div>
              <div className="row-between">
                <div className="kpi-value">{kpis.coutTotal} dt</div>
                <div className="kpi-trend">Budget sous contrôle</div>
              </div>
            </div>
          </div>
          <div className="tabs">
            <button className={`tab-btn ${activeSection === 'interventions' ? 'active' : ''}`} onClick={() => setActiveSection('interventions')}>Interventions</button>
            <button className={`tab-btn ${activeSection === 'agents' ? 'active' : ''}`} onClick={() => setActiveSection('agents')}>Agents</button>
            <button className={`tab-btn ${activeSection === 'rapports' ? 'active' : ''}`} onClick={() => setActiveSection('rapports')}>Rapports</button>
            <button className={`tab-btn ${activeSection === 'equipements' ? 'active' : ''}`} onClick={() => setActiveSection('equipements')}>Équipements</button>
            <button className={`tab-btn ${activeSection === 'citoyens' ? 'active' : ''}`} onClick={() => setActiveSection('citoyens')}>Citoyens</button>
          </div>
        {activeSection === 'citoyens' && (
            <div className="panel">
              <div className="panel-header"><span>Citoyens</span><span>{citoyens.length} inscrits</span></div>
              <div className="list">
                {citoyens.map((citizen) => (
                  <div key={citizen.cin} className="card-item" style={{ gridTemplateColumns: '1fr auto' }}>
                    <div>
                      <div className="title">{citizen.nom} {citizen.prenom}</div>
                      <div className="meta">CIN {citizen.cin} · {citizen.email}</div>
                      <div className="meta">Adresse : {citizen.adresse}</div>
                      <div className="meta">Rue : {citizen.rue}</div>
                    </div>
                    <span className="badge badge-ok">Citoyen</span>
                  </div>
                ))}
                {citoyens.length === 0 && <div className="empty">Aucun citoyen enregistré.</div>}
              </div>
            </div>
          )}

          {activeSection === 'interventions' && (
            <div className="panel">
              <div className="panel-header"><span>Interventions</span><span>{interventions.length} suivies</span></div>
              <div className="list">
                {interventions.map((i) => (
                  <div
                    key={i.id}
                    className="card-item"
                    onClick={() => setSelectedIntervention(i)}
                    style={{ cursor: 'pointer', borderColor: selectedIntervention?.id === i.id ? 'var(--accent)' : undefined }}
                  >
                    <div>
                      <div className="title">#{i.id} · {i.type}</div>
                      <div className="meta">{i.localisation} · Agent {i.cinAgent}</div>
                      <Progress value={i.etat} />
                    </div>
                    <div style={{ display: 'grid', gap: 6, justifyItems: 'end' }}>
                      <BadgeEtat value={i.etat} />
                      <span className="meta">Urgence {i.urgence}/5</span>
                    </div>
                  </div>
                ))}
                {interventions.length === 0 && <div className="empty">Aucune intervention.</div>}
              </div>

              <div className="panel" style={{ marginTop: 12 }}>
                <div className="panel-header"><span>Détail intervention</span><span>{selectedIntervention ? `#${selectedIntervention.id}` : ''}</span></div>
                {selectedIntervention ? (
                  <div className="list">
                    <div className="card-item" style={{ gridTemplateColumns: '1fr' }}>
                      <div className="title">{selectedIntervention.type}</div>
                      <div className="meta">Localisation: {selectedIntervention.localisation}</div>
                      <div className="meta">Agent affecté: {selectedIntervention.cinAgent}</div>
                      <div className="meta">Urgence: {selectedIntervention.urgence}/5</div>
                      <div className="meta">Avancement:</div>
                      <Progress value={selectedIntervention.etat} />
                      <BadgeEtat value={selectedIntervention.etat} />
                    </div>
                  </div>
                ) : (
                  <div className="empty">Appuyez sur une intervention pour voir le détail.</div>
                )}
              </div>
            </div>
          )}

          {activeSection === 'agents' && (
            <div className="panel">
              <div className="panel-header"><span>Agents</span><span>{agents.length} au total</span></div>
              <div className="list">
                {agents.map((a) => (
                  <div key={a.cin} className="card-item">
                    <div>
                      <div className="title">{a.nom} {a.prenom}</div>
                      <div className="meta">CIN {a.cin} · {a.service}</div>
                    </div>
                    <span className={`badge ${a.disponibilite ? 'badge-ok' : 'badge-danger'}`}>
                      {a.disponibilite ? 'Disponible' : 'Occupé'}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {activeSection === 'rapports' && (
            <div className="panel">
              <div className="panel-header"><span>Rapports</span><span>{rapports.length} reçus</span></div>
              <div className="list">
                {rapports.map((r, idx) => (
                  <div
                    key={idx}
                    className="card-item"
                    onClick={() => setSelectedRapport(r)}
                    style={{ cursor: 'pointer', borderColor: selectedRapport === r ? 'var(--accent)' : undefined }}
                  >
                    <div>
                      <div className="title">Rapport Intervention #{r.interventionRef}</div>
                      <div className="meta">Agent {r.cinAgent}</div>
                      <div className="meta">Durée {r.duree} jours · Coût {r.cout} dt</div>
                      <div className="meta">{r.description}</div>
                    </div>
                  </div>
                ))}
                {rapports.length === 0 && <div className="empty">Aucun rapport.</div>}
              </div>

              <div className="panel" style={{ marginTop: 12 }}>
                <div className="panel-header"><span>Détail rapport</span><span>{selectedRapport ? `Intervention #${selectedRapport.interventionRef}` : ''}</span></div>
                {selectedRapport ? (
                  <div className="list">
                    <div className="card-item" style={{ gridTemplateColumns: '1fr' }}>
                      <div className="title">Rapport Intervention #{selectedRapport.interventionRef}</div>
                      <div className="meta">Agent: {selectedRapport.cinAgent}</div>
                      <div className="meta">Durée: {selectedRapport.duree} jours</div>
                      <div className="meta">Coût: {selectedRapport.cout} dt</div>
                      <div className="meta">Description: {selectedRapport.description}</div>
                      {selectedRapport.image && selectedRapport.image.length > 0 && (
                          <div style={{marginTop: 10}}>
                              <img src={`data:image/jpeg;base64,${selectedRapport.image}`} style={{maxWidth: '100%', borderRadius: 8}} />
                          </div>
                      )}
                    </div>
                  </div>
                ) : (
                  <div className="empty">Appuyez sur un rapport pour voir le détail.</div>
                )}
              </div>
            </div>
          )}

          {activeSection === 'equipements' && (
            <div className="panel">
              <div className="panel-header"><span>Équipements</span><span>{equipements.length} items</span></div>
              <div className="list">
                {equipements.map((e) => (
                  <div key={e.id} className="card-item">
                    <div>
                      <div className="title">{e.nom}</div>
                      <div className="meta">ID {e.id}</div>
                    </div>
                    <span className={`badge ${e.disponible ? 'badge-ok' : 'badge-danger'}`}>
                      {e.disponible ? 'Disponible' : 'Mobilisé'}
                    </span>
                  </div>
                ))}
                {equipements.length === 0 && <div className="empty">Aucun équipement.</div>}
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
