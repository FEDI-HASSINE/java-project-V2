<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Espace Chef Informatique - Maquette</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #050915;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.12);
      --accent: #22d3ee;
      --accent-2: #7c3aed;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --success: #34d399;
      --danger: #f87171;
      --radius: 14px;
      --shadow: 0 20px 80px rgba(0,0,0,0.45);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Space Grotesk', 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 18% 24%, rgba(34,211,238,0.16), transparent 34%),
                  radial-gradient(circle at 82% 12%, rgba(124,58,237,0.16), transparent 36%),
                  linear-gradient(135deg, #0b1024, #050915);
      color: var(--text);
      padding: 26px;
    }

    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; gap: 12px; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: -0.2px; }
    .brand-dot { width: 11px; height: 11px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: 0 0 18px rgba(34,211,238,0.45); }

    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px; }
    .kpi-card { background: var(--panel); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; box-shadow: var(--shadow); display: grid; gap: 6px; }
    .kpi-label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; }
    .kpi-value { font-size: 24px; font-weight: 700; }

    .tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px; }
    .tab-btn { padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: var(--panel); color: var(--text); cursor: pointer; font-weight: 600; }
    .tab-btn.active { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(34,211,238,0.35); background: linear-gradient(120deg, rgba(34,211,238,0.15), rgba(124,58,237,0.1)); }

    .panel { background: var(--panel); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); backdrop-filter: blur(12px); }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; color: var(--muted); font-size: 12px; letter-spacing: 0.35px; text-transform: uppercase; }

    .list { display: flex; flex-direction: column; gap: 10px; }
    .card-item { padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); background: var(--panel-strong); display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .title { font-weight: 600; letter-spacing: 0.1px; }
    .meta { color: var(--muted); font-size: 13px; }
    .empty { color: var(--muted); font-size: 13px; text-align: center; padding: 18px 0; }

    .btn { border: 1px solid rgba(255,255,255,0.14); color: var(--text); background: var(--panel); padding: 8px 12px; border-radius: 12px; cursor: pointer; font-weight: 600; }
    .btn:hover { border-color: var(--accent); }
    .btn-danger { border-color: rgba(248,113,113,0.4); color: #fecdd3; }
    .btn-primary { background: linear-gradient(120deg, var(--accent), var(--accent-2)); color: #0b1120; border: none; box-shadow: 0 12px 32px rgba(124,58,237,0.35); }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: grid; place-items: center; z-index: 10; backdrop-filter: blur(4px); }
    .modal { width: min(520px, 92vw); background: var(--panel); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow); max-height: 90vh; overflow-y: auto; }

    form { display: flex; flex-direction: column; gap: 12px; }
    label { color: var(--muted); font-size: 13px; }
    input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: var(--text); outline: none; font-family: inherit; font-size: 14px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    function getApiBase() {
        const host = window.location.hostname;
        const isLocal = host === 'localhost' || host === '127.0.0.1' || host === '0.0.0.0';
        if (isLocal) {
            return 'http://localhost:8080';
        }
        const proto = window.location.protocol === 'https:' ? 'https' : 'http';
        return `${proto}://${host.replace('-8000', '-8080')}`;
    }

    function parseJwt(token) {
        try {
          const base64Url = token.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
    }

    const ROLE_CONFIG = {
      citoyens: { label: 'Citoyens', canAdd: false, canEdit: true, canDelete: true, endpoint: '/citoyens' },
      responsableMunicipalites: { label: 'Responsables Municipaux', canAdd: true, canEdit: true, canDelete: true, endpoint: '/responsableMunicipalites' },
      agents: { label: 'Agents', canAdd: true, canEdit: true, canDelete: true, endpoint: '/agents' },
      chefsInfo: { label: 'Chefs Informatique', canAdd: true, canEdit: true, canDelete: true, endpoint: '/chefs-informatiques' },
      chefGeneral: { label: 'Chef Général', canAdd: false, canEdit: true, canDelete: false, endpoint: '/chefs-generaux' }
    };

    function Modal({ children, onClose }) {
      return (
        <div className="modal-backdrop" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            {children}
          </div>
        </div>
      );
    }

    function FormContent({ role, initial, onSubmit, onCancel }) {
      const [form, setForm] = useState(initial || {});

      const handleChange = (key, value) => setForm((prev) => ({ ...prev, [key]: value }));

      const fieldsByRole = {
        citoyens: [
          { key: 'cin', label: 'CIN', required: true, pattern: "\\d{8}", title: "8 chiffres" },
          { key: 'email', label: 'Email', required: true, type: 'email' },
          { key: 'password', label: 'Mot de passe', required: true, minLength: 6 },
          { key: 'nom', label: 'Nom', required: true },
          { key: 'prenom', label: 'Prénom', required: true },
          { key: 'role', label: 'Rôle', required: true },
          { key: 'adresse', label: 'Adresse', required: true },
          { key: 'rue', label: 'Rue', required: true }
        ],
        responsableMunicipalites: [
          { key: 'cin', label: 'CIN', required: true, pattern: "\\d{8}", title: "8 chiffres" },
          { key: 'email', label: 'Email', required: true, type: 'email' },
          { key: 'password', label: 'Mot de passe', required: true, minLength: 6 },
          { key: 'nom', label: 'Nom', required: true },
          { key: 'prenom', label: 'Prénom', required: true }
        ],
        agents: [
          { key: 'cin', label: 'CIN', required: true, pattern: "\\d{8}", title: "8 chiffres" },
          { key: 'email', label: 'Email', required: true, type: 'email' },
          { key: 'password', label: 'Mot de passe', required: true, minLength: 6 },
          { key: 'nom', label: 'Nom', required: true },
          { key: 'prenom', label: 'Prénom', required: true },
          { key: 'service', label: 'Service', required: true }
        ],
        chefsInfo: [
          { key: 'cin', label: 'CIN', required: true, pattern: "\\d{8}", title: "8 chiffres" },
          { key: 'email', label: 'Email', required: true, type: 'email' },
          { key: 'password', label: 'Mot de passe', required: true, minLength: 6 },
          { key: 'nom', label: 'Nom', required: true },
          { key: 'prenom', label: 'Prénom', required: true }
        ],
        chefGeneral: [
          { key: 'cin', label: 'CIN', required: true, pattern: "\\d{8}", title: "8 chiffres" },
          { key: 'email', label: 'Email', required: true, type: 'email' },
          { key: 'password', label: 'Mot de passe', required: true, minLength: 6 },
          { key: 'nom', label: 'Nom', required: true },
          { key: 'prenom', label: 'Prénom', required: true },
          { key: 'role', label: 'Rôle', required: true }
        ]
      };

      let fields = fieldsByRole[role] || [];
      
      const submit = (e) => {
        e.preventDefault();
        const dataToSubmit = { ...form };
        // Set default availability for new agents
        if (role === 'agents' && !initial) {
            dataToSubmit.disponibilite = true;
        }
        onSubmit(dataToSubmit);
      };

      return (
        <form onSubmit={submit}>
          <h3>{initial ? 'Modifier' : 'Créer'} {ROLE_CONFIG[role]?.label?.slice(0, -1) || ''}</h3>
          {fields.map((f) => (
            <div key={f.key}>
              <label>{f.label}</label>
              {f.type === 'select' ? (
                <select value={form[f.key]} onChange={(e) => handleChange(f.key, e.target.value === 'true')} required={f.required}>
                  {f.options.map((opt) => (
                    <option key={opt.label} value={opt.value}>{opt.label}</option>
                  ))}
                </select>
              ) : (
                <input 
                    type={f.type || 'text'} 
                    value={form[f.key] || ''} 
                    onChange={(e) => handleChange(f.key, e.target.value)} 
                    required={initial && f.key === 'password' ? false : f.required} 
                    placeholder={initial && f.key === 'password' ? "Laisser vide pour ne pas changer" : ""}
                    pattern={f.pattern}
                    minLength={f.minLength}
                    title={f.title}
                />
              )}
            </div>
          ))}
          <div className="actions" style={{ justifyContent: 'flex-end' }}>
            <button type="button" className="btn" onClick={onCancel}>Annuler</button>
            <button type="submit" className="btn-primary">Enregistrer</button>
          </div>
        </form>
      );
    }

    function ListSection({ title, items, roleKey, onAdd, onEdit, onDelete }) {
      const cfg = ROLE_CONFIG[roleKey];
      // chefGeneral is now a list from API
      const listItems = items || [];

      return (
        <div className="panel">
          <div className="panel-header">
            <span>{title}</span>
            <div className="actions">
              {cfg.canAdd && <button className="btn" onClick={onAdd}>Ajouter</button>}
            </div>
          </div>
          <div className="list">
            {(!listItems || listItems.length === 0) && <div className="empty">Aucun enregistrement.</div>}
            {listItems && listItems.map((item) => (
              <div key={item.cin} className="card-item">
                <div>
                  <div className="title">{item.nom} {item.prenom || ''}</div>
                  <div className="meta">CIN {item.cin}{item.role ? ` · ${item.role}` : ''}{item.email ? ` · ${item.email}` : ''}</div>
                  {item.service && <div className="meta">Service: {item.service}</div>}
                  {item.adresse && <div className="meta">Adresse: {item.adresse}</div>}
                  {item.rue && <div className="meta">Rue: {item.rue}</div>}
                  {item.disponibilite !== undefined && <div className="meta">Disponible: {item.disponibilite ? 'Oui' : 'Non'}</div>}
                </div>
                <div className="actions">
                  {cfg.canEdit && <button className="btn" onClick={() => onEdit(item)}>Modifier</button>}
                  {cfg.canDelete && <button className="btn btn-danger" onClick={() => onDelete(item)}>Supprimer</button>}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function App() {
      const [activeTab, setActiveTab] = useState('citoyens');
      const [data, setData] = useState({
        citoyens: [],
        responsableMunicipalites: [],
        agents: [],
        chefsInfo: [],
        chefGeneral: []
      });
      const [modalState, setModalState] = useState({ open: false, role: null, mode: 'create', current: null });

      const token = sessionStorage.getItem('municipaliteToken') || localStorage.getItem('municipaliteToken');

      useEffect(() => {
        if (!token) {
            window.location.href = 'login.html';
            return;
        }
        const user = parseJwt(token);
        if (!user || user.role !== 'chefinfo') {
             // alert('Accès refusé');
             // window.location.href = 'login.html';
        }
        loadAllData();
      }, [token]);

      const loadAllData = async () => {
          const headers = { 'Authorization': `Bearer ${token}` };
          const base = getApiBase();

          try {
              const [citoyens, responsableMunicipalites, agents, chefsInfo, chefGeneral] = await Promise.all([
                  fetch(`${base}/citoyens`, { headers }).then(r => r.ok ? r.json() : []),
                  fetch(`${base}/responsableMunicipalites`, { headers }).then(r => r.ok ? r.json() : []),
                  fetch(`${base}/agents`, { headers }).then(r => r.ok ? r.json() : []),
                  fetch(`${base}/chefs-informatiques`, { headers }).then(r => r.ok ? r.json() : []),
                  fetch(`${base}/chefs-generaux`, { headers }).then(r => r.ok ? r.json() : [])
              ]);

              setData({
                  citoyens,
                  responsableMunicipalites,
                  agents,
                  chefsInfo,
                  chefGeneral
              });
          } catch (e) {
              console.error("Erreur chargement données", e);
          }
      };

      const openCreate = (role) => setModalState({ open: true, role, mode: 'create', current: null });
      const openEdit = (role, item) => setModalState({ open: true, role, mode: 'edit', current: item });
      const closeModal = () => setModalState({ open: false, role: null, mode: 'create', current: null });

      const handleSubmit = async (values) => {
        const role = modalState.role;
        if (!role) return;
        
        const cfg = ROLE_CONFIG[role];
        const base = getApiBase();
        const headers = { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };

        try {
            let res;
            if (modalState.mode === 'create') {
                res = await fetch(`${base}${cfg.endpoint}`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(values)
                });
            } else {
                res = await fetch(`${base}${cfg.endpoint}/${values.cin}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(values)
                });
            }

            if (res.ok) {
                loadAllData();
                closeModal();
            } else {
                try {
                    const errData = await res.json();
                    console.error("Server error:", errData);
                    alert('Erreur: ' + (errData.message || "Vérifiez vos données (CIN 8 chiffres, Email valide, etc.)"));
                } catch (e) {
                    alert('Erreur lors de l\'enregistrement');
                }
            }
        } catch (e) {
            console.error(e);
            alert('Erreur réseau');
        }
      };

      const handleDelete = async (role, item) => {
        if (role === 'agents' && item.dispo === false) {
            alert("Impossible de supprimer un agent non disponible.");
            return;
        }
        if (!confirm('Êtes-vous sûr ?')) return;
        
        const cfg = ROLE_CONFIG[role];
        const base = getApiBase();
        const headers = { 'Authorization': `Bearer ${token}` };

        try {
            const res = await fetch(`${base}${cfg.endpoint}/${item.cin}`, {
                method: 'DELETE',
                headers
            });

            if (res.ok) {
                loadAllData();
            } else {
                alert('Erreur lors de la suppression');
            }
        } catch (e) {
            console.error(e);
            alert('Erreur réseau');
        }
      };

      const kpis = useMemo(() => ({
        citoyens: data.citoyens.length,
        responsableMunicipalites: data.responsableMunicipalites.length,
        agents: data.agents.length,
        chefsInfo: data.chefsInfo.length,
        chefGeneral: data.chefGeneral.length
      }), [data]);

      return (
        <div>
          <header>
            <div className="brand"><span className="brand-dot"></span> Chef Informatique</div>
            <div style={{ color: 'var(--muted)', fontSize: 13 }}>Gestion des comptes</div>
          </header>

          <div className="kpi-grid">
            <div className="kpi-card"><div className="kpi-label">Citoyens</div><div className="kpi-value">{kpis.citoyens}</div></div>
            <div className="kpi-card"><div className="kpi-label">Responsables Municipaux</div><div className="kpi-value">{kpis.responsableMunicipalites}</div></div>
            <div className="kpi-card"><div className="kpi-label">Agents</div><div className="kpi-value">{kpis.agents}</div></div>
            <div className="kpi-card"><div className="kpi-label">Chefs Info</div><div className="kpi-value">{kpis.chefsInfo}</div></div>
            <div className="kpi-card"><div className="kpi-label">Chef Général</div><div className="kpi-value">{kpis.chefGeneral}</div></div>
          </div>

          <div className="tabs">
            <button className={`tab-btn ${activeTab === 'citoyens' ? 'active' : ''}`} onClick={() => setActiveTab('citoyens')}>Citoyens</button>
            <button className={`tab-btn ${activeTab === 'responsableMunicipalites' ? 'active' : ''}`} onClick={() => setActiveTab('responsableMunicipalites')}>Responsables Municipaux</button>
            <button className={`tab-btn ${activeTab === 'agents' ? 'active' : ''}`} onClick={() => setActiveTab('agents')}>Agents</button>
            <button className={`tab-btn ${activeTab === 'chefsInfo' ? 'active' : ''}`} onClick={() => setActiveTab('chefsInfo')}>Chefs Informatique</button>
            <button className={`tab-btn ${activeTab === 'chefGeneral' ? 'active' : ''}`} onClick={() => setActiveTab('chefGeneral')}>Chef Général</button>
          </div>

          {activeTab === 'citoyens' && (
            <ListSection
              title="Citoyens"
              items={data.citoyens}
              roleKey="citoyens"
              onAdd={() => openCreate('citoyens')}
              onEdit={(item) => openEdit('citoyens', item)}
              onDelete={(item) => handleDelete('citoyens', item)}
            />
          )}

          {activeTab === 'responsableMunicipalites' && (
            <ListSection
              title="Responsables Municipaux"
              items={data.responsableMunicipalites}
              roleKey="responsableMunicipalites"
              onAdd={() => openCreate('responsableMunicipalites')}
              onEdit={(item) => openEdit('responsableMunicipalites', item)}
              onDelete={(item) => handleDelete('responsableMunicipalites', item)}
            />
          )}

          {activeTab === 'agents' && (
            <ListSection
              title="Agents"
              items={data.agents}
              roleKey="agents"
              onAdd={() => openCreate('agents')}
              onEdit={(item) => openEdit('agents', item)}
              onDelete={(item) => handleDelete('agents', item)}
            />
          )}

          {activeTab === 'chefsInfo' && (
            <ListSection
              title="Chefs Informatique"
              items={data.chefsInfo}
              roleKey="chefsInfo"
              onAdd={() => openCreate('chefsInfo')}
              onEdit={(item) => openEdit('chefsInfo', item)}
              onDelete={(item) => handleDelete('chefsInfo', item)}
            />
          )}

          {activeTab === 'chefGeneral' && (
            <ListSection
              title="Chef Général"
              items={data.chefGeneral}
              roleKey="chefGeneral"
              onAdd={() => openCreate('chefGeneral')}
              onEdit={(item) => openEdit('chefGeneral', item)}
              onDelete={() => {}}
            />
          )}

          {modalState.open && (
            <Modal onClose={closeModal}>
              <FormContent
                role={modalState.role}
                initial={modalState.mode === 'edit' ? modalState.current : undefined}
                onSubmit={handleSubmit}
                onCancel={closeModal}
              />
            </Modal>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
