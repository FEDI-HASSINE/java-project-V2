<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Espace Agent - Interventions</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0c1224;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.12);
      --accent: #22d3ee;
      --accent-2: #7c3aed;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --danger: #f87171;
      --success: #4ade80;
      --shadow: 0 20px 80px rgba(0,0,0,0.45);
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Space Grotesk', 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 8% 18%, rgba(34,211,238,0.16), transparent 30%),
                  radial-gradient(circle at 84% 10%, rgba(124,58,237,0.18), transparent 34%),
                  radial-gradient(circle at 50% 80%, rgba(124,58,237,0.12), transparent 40%),
                  var(--bg);
      padding: 26px;
    }

    header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 18px; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: -0.2px; }
    .brand-dot { width: 10px; height: 10px; border-radius: 50%; background: linear-gradient(120deg, var(--accent), var(--accent-2)); box-shadow: 0 0 18px rgba(34,211,238,0.45); }

    .layout { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 18px; }
    .panel { background: var(--panel); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); backdrop-filter: blur(12px); }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; color: var(--muted); font-size: 12px; letter-spacing: 0.4px; text-transform: uppercase; }

    .list { display: flex; flex-direction: column; gap: 10px; }
    .card-item { padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); background: var(--panel-strong); display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; cursor: pointer; transition: border 0.12s ease, transform 0.12s ease; }
    .card-item:hover { border-color: var(--accent); transform: translateY(-1px); }
    .title { font-weight: 600; letter-spacing: 0.1px; }
    .meta { color: var(--muted); font-size: 13px; }

    .detail { display: grid; gap: 10px; }
    .detail-row { display: flex; justify-content: space-between; color: var(--muted); font-size: 13px; }
    .detail-row span:last-child { color: var(--text); font-weight: 600; }
    .empty { color: var(--muted); font-size: 13px; text-align: center; padding: 20px 0; }

    .progress-wrap { margin-top: 12px; }
    .progress-bar { width: 100%; height: 10px; background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(120deg, var(--accent), var(--accent-2)); }

    .btn { border: 1px solid rgba(255,255,255,0.14); color: var(--text); background: var(--panel); padding: 10px 14px; border-radius: var(--radius); cursor: pointer; font-weight: 600; letter-spacing: 0.1px; transition: transform 0.12s ease, box-shadow 0.12s ease, border 0.12s ease; backdrop-filter: blur(12px); }
    .btn:hover { transform: translateY(-1px); border-color: var(--accent); box-shadow: 0 10px 28px rgba(34,211,238,0.25); }
    .btn-primary { background: linear-gradient(120deg, var(--accent), var(--accent-2)); color: #0b1120; border: none; box-shadow: 0 12px 32px rgba(124,58,237,0.35); }
    .btn-primary:hover { box-shadow: 0 16px 44px rgba(124,58,237,0.45); }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: grid; place-items: center; z-index: 10; backdrop-filter: blur(4px); }
    .modal { width: min(560px, 92vw); background: var(--panel); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow); }
    form { display: flex; flex-direction: column; gap: 12px; }
    label { color: var(--muted); font-size: 13px; }
    input, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: var(--text); outline: none; font-family: inherit; font-size: 14px; }
    textarea { min-height: 100px; resize: vertical; }

    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    function getApiBase() {
        const host = window.location.hostname;
        const isLocal = host === 'localhost' || host === '127.0.0.1' || host === '0.0.0.0';
        if (isLocal) {
            return 'http://localhost:8080';
        }
        const proto = window.location.protocol === 'https:' ? 'https' : 'http';
        return `${proto}://${host.replace('-8000', '-8080')}`;
    }

    function parseJwt(token) {
        try {
          const base64Url = token.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
    }

    function DemandesList({ interventions, onSelect }) {
      if (!interventions.length) return <div className="empty">Aucune intervention assignée.</div>;
      return (
        <div className="list">
          {interventions.map((i) => (
            <div key={i.id} className="card-item" onClick={() => onSelect(i)}>
              <div>
                <div className="title">Intervention #{i.id}</div>
                <div className="meta">{i.localisation} · {i.dateDebut}</div>
              </div>
              <div className="progress-wrap" style={{ width: 120 }}>
                <div className="progress-bar">
                  <div className="progress-fill" style={{ width: `${Math.min(100, i.etat)}%` }}></div>
                </div>
                <div className="meta" style={{ textAlign: 'right' }}>{i.etat}%</div>
              </div>
            </div>
          ))}
        </div>
      );
    }

    function DemandeDetail({ intervention, onUpdateProgress }) {
      const [showImage, setShowImage] = useState(false);
      const [localEtat, setLocalEtat] = useState(0);
      
      useEffect(() => { 
          setShowImage(false); 
          if (intervention) {
              setLocalEtat(intervention.etat);
          }
      }, [intervention]);

      if (!intervention) return <div className="empty">Sélectionnez une intervention pour voir les détails.</div>;
      
      const hasImage = intervention.image && intervention.image.length > 0 && intervention.image !== '(binaire)';

      const handleSave = () => {
          onUpdateProgress(localEtat);
      };

      return (
        <div className="detail">
          <div className="title">Intervention #{intervention.id}</div>
          <div className="detail-row"><span>Budget</span><span>{intervention.budget}</span></div>
          <div className="detail-row"><span>Date début</span><span>{intervention.dateDebut}</span></div>
          <div className="detail-row"><span>Type</span><span>{intervention.type}</span></div>
          <div className="detail-row"><span>Urgence</span><span>{intervention.urgence}</span></div>
          <div className="detail-row"><span>Localisation</span><span>{intervention.localisation}</span></div>
          <div className="detail-row">
            <span>Image</span>
            <span>
                {hasImage ? (
                    <span 
                        style={{color: 'var(--accent)', cursor: 'pointer', textDecoration: 'underline'}}
                        onClick={() => setShowImage(!showImage)}
                    >
                        {showImage ? 'Masquer' : 'Voir'}
                    </span>
                ) : 'Aucune'}
            </span>
          </div>
          {showImage && hasImage && (
            <div style={{ marginTop: 12, textAlign: 'center' }}>
              <img 
                src={`data:image/jpeg;base64,${intervention.image}`} 
                alt="Preuve" 
                style={{ maxWidth: '100%', borderRadius: '8px', border: '1px solid rgba(255,255,255,0.1)' }} 
              />
            </div>
          )}
          <div className="progress-wrap">
            <label style={{ color: 'var(--muted)', fontSize: 13 }}>Avancement (etat en %)</label>
            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                <input
                  type="range"
                  min="0"
                  max="100"
                  value={localEtat}
                  onChange={(e) => setLocalEtat(Number(e.target.value))}
                  style={{ flex: 1 }}
                />
                <div className="meta" style={{ width: '40px', textAlign: 'right' }}>{localEtat}%</div>
            </div>
            <button 
                className="btn btn-primary" 
                style={{ width: '100%', marginTop: '10px' }}
                onClick={handleSave}
            >
                Enregistrer
            </button>
          </div>
        </div>
      );
    }

    function RapportModal({ onClose, onSubmit, loading }) {
      const [cout, setCout] = useState(0);
      const [duree, setDuree] = useState(1);
      const [description, setDescription] = useState('');
      const [image, setImage] = useState(null);

      const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit({ cout, duree, description, image });
      };

      const handleImageChange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            // Remove data:image/jpeg;base64, prefix
            const base64 = reader.result.split(',')[1];
            setImage(base64);
          };
          reader.readAsDataURL(file);
        }
      };

      return (
        <div className="modal-backdrop">
          <div className="modal">
            <div className="panel-header">
              <span>Rapport de travail</span>
              <span style={{cursor: 'pointer'}} onClick={onClose}>✕</span>
            </div>
            <form onSubmit={handleSubmit}>
              <div>
                <label>Coût (DT)</label>
                <input type="number" min="0" value={cout} onChange={e => setCout(Number(e.target.value))} required />
              </div>
              <div>
                <label>Durée (jours)</label>
                <input type="number" min="1" value={duree} onChange={e => setDuree(Number(e.target.value))} required />
              </div>
              <div>
                <label>Description</label>
                <textarea value={description} onChange={e => setDescription(e.target.value)} required placeholder="Détails du travail effectué..."></textarea>
              </div>
              <div>
                <label>Image (Optionnel)</label>
                <input type="file" accept="image/*" onChange={handleImageChange} />
              </div>
              <div style={{ display: 'flex', gap: '10px', marginTop: '10px' }}>
                <button type="button" className="btn" onClick={onClose} style={{flex: 1}}>Annuler</button>
                <button type="submit" className="btn btn-primary" style={{flex: 1}} disabled={loading}>
                  {loading ? 'Enregistrement...' : 'Terminer Intervention'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function RapportsList({ rapports }) {
      if (!rapports.length) return <div className="empty">Aucun rapport trouvé.</div>;
      return (
        <div className="list">
          {rapports.map((r, idx) => (
            <div key={idx} className="card-item" style={{ cursor: 'default' }}>
              <div>
                <div className="title">Intervention #{r.interventionRef}</div>
                <div className="meta">Coût: {r.cout} DT · Durée: {r.duree} jours</div>
                <div className="meta" style={{marginTop: 4}}>{r.description}</div>
              </div>
            </div>
          ))}
        </div>
      );
    }

    function App() {
      const [token, setToken] = useState(sessionStorage.getItem('municipaliteToken') || localStorage.getItem('municipaliteToken') || '');
      const [view, setView] = useState('interventions'); // 'interventions' | 'rapports'
      
      const [interventions, setInterventions] = useState([]);
      const [rapports, setRapports] = useState([]);
      
      const [selected, setSelected] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [userCin, setUserCin] = useState('');
      
      const [showReportModal, setShowReportModal] = useState(false);
      const [reportLoading, setReportLoading] = useState(false);

      const API = getApiBase();

      useEffect(() => {
        if (!token) {
          window.location.href = 'login.html';
          return;
        }
        const decoded = parseJwt(token);
        if (decoded && decoded.cin) {
            setUserCin(decoded.cin);
            loadInterventions(decoded.cin);
        } else {
            setError("Impossible de récupérer le CIN de l'agent.");
        }
      }, [token]);

      useEffect(() => {
          if (view === 'rapports' && userCin) {
              loadRapports();
          }
      }, [view, userCin]);

      async function loadInterventions(cin) {
        setLoading(true);
        try {
            const response = await fetch(`${API}/interventions/agent/${cin}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                const data = await response.json();
                setInterventions(data);
                if (data.length > 0) setSelected(data[0]);
            } else {
                setError("Erreur lors du chargement des interventions.");
            }
        } catch (e) {
            setError("Erreur réseau.");
            console.error(e);
        } finally {
            setLoading(false);
        }
      }

      async function loadRapports() {
        setLoading(true);
        try {
            const response = await fetch(`${API}/rapports/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                const data = await response.json();
                setRapports(data);
            } else {
                console.error("Erreur chargement rapports");
            }
        } catch (e) {
            console.error(e);
        } finally {
            setLoading(false);
        }
      }

      const handleUpdateProgress = async (value) => {
        if (!selected) return;
        
        // Optimistic update
        const updated = { ...selected, etat: value };
        setInterventions((prev) => prev.map((i) => i.id === selected.id ? updated : i));
        setSelected(updated);

        try {
            await fetch(`${API}/interventions/${selected.id}/etat`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ etat: value })
            });
            
            if (value === 100) {
                setShowReportModal(true);
            }
        } catch (e) {
            console.error("Erreur sauvegarde etat", e);
        }
      };

      const handleSubmitReport = async (reportData) => {
          if (!selected) return;
          setReportLoading(true);
          try {
              const response = await fetch(`${API}/interventions/${selected.id}/rapports`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify({
                      cout: reportData.cout,
                      duree: reportData.duree,
                      description: reportData.description,
                      imageBase64: reportData.image
                  })
              });

              if (response.ok) {
                  // Success: Remove intervention from list
                  setInterventions(prev => prev.filter(i => i.id !== selected.id));
                  setSelected(null);
                  setShowReportModal(false);
                  alert("Rapport enregistré et intervention terminée !");
                  // Refresh reports if we are in that view (unlikely but good practice)
                  if (view === 'rapports') loadRapports();
              } else {
                  const err = await response.text();
                  alert("Erreur: " + err);
              }
          } catch (e) {
              console.error(e);
              alert("Erreur réseau lors de l'envoi du rapport.");
          } finally {
              setReportLoading(false);
          }
      };

      return (
        <div>
          <header>
            <div className="brand"><span className="brand-dot"></span> Espace Agent</div>
            <div style={{ display: 'flex', gap: '20px', alignItems: 'center' }}>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button 
                        className={`btn ${view === 'interventions' ? 'btn-primary' : ''}`}
                        onClick={() => setView('interventions')}
                    >
                        Interventions
                    </button>
                    <button 
                        className={`btn ${view === 'rapports' ? 'btn-primary' : ''}`}
                        onClick={() => setView('rapports')}
                    >
                        Mes Rapports
                    </button>
                </div>
                <div className="meta">{userCin ? `CIN: ${userCin}` : ''}</div>
            </div>
          </header>

          {error && <div style={{color: 'var(--danger)', marginBottom: 10}}>{error}</div>}

          {view === 'interventions' ? (
              <div className="layout">
                <div className="panel">
                  <div className="panel-header"><span>Interventions assignées</span><span>{interventions.length}</span></div>
                  {loading ? <div className="meta">Chargement...</div> : (
                      <DemandesList interventions={interventions} onSelect={setSelected} />
                  )}
                </div>
                <div className="panel">
                  <div className="panel-header"><span>Détails</span><span></span></div>
                  <DemandeDetail intervention={selected} onUpdateProgress={handleUpdateProgress} />
                </div>
              </div>
          ) : (
              <div className="panel">
                  <div className="panel-header"><span>Mes Rapports</span><span>{rapports.length}</span></div>
                  {loading ? <div className="meta">Chargement...</div> : (
                      <RapportsList rapports={rapports} />
                  )}
              </div>
          )}
          
          {showReportModal && (
              <RapportModal 
                  onClose={() => setShowReportModal(false)} 
                  onSubmit={handleSubmitReport} 
                  loading={reportLoading}
              />
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
