<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent - Interventions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
      :root { --bg:#0b1220; --panel:#121a2b; --text:#e6eaf2; --muted:#a8b0c3; --accent:#6ea8fe; --danger:#ff6b6b; --success:#3ddc97; }
      * { box-sizing: border-box; }
      body { margin:0; font-family:'Inter',system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); }
      .container { max-width:1100px; margin:0 auto; padding:24px; }
      .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
      .title { font-weight:700; font-size:20px; }
      .panel { background:var(--panel); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:16px; }
      .list { display:grid; grid-template-columns:1fr; gap:12px; }
      .item { padding:12px; border:1px solid rgba(255,255,255,0.06); border-radius:10px; display:flex; align-items:center; justify-content:space-between; }
      .btn { background:#1a2340; color:var(--text); border:1px solid rgba(255,255,255,0.12); border-radius:8px; padding:8px 12px; cursor:pointer; }
      .btn:hover { border-color:var(--accent); }
      .btn-primary { background:#1a2a55; border-color:#315fb9; }
      .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
      .detail-row { display:grid; grid-template-columns:280px 1fr; gap:8px; align-items:center; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,0.06); }
      .input { width:100%; padding:10px; background:#0d1426; color:var(--text); border:1px solid rgba(255,255,255,0.12); border-radius:8px; }
      .muted { color:var(--muted); font-size:12px; }
      .error { color:var(--danger); }
      .success { color:var(--success); }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useEffect, useState } = React;

      function getApiBase() {
        const host = window.location.hostname;
        const isCodespaces = host.includes("github.dev") || host.includes("githubpreview.dev") || host.includes("codespaces");
        return isCodespaces ? `https://${host.replace(':8000','')}` : `http://localhost:8080`;
      }

      async function fetchJSON(url, options={}) {
        const resp = await fetch(url, options);
        const contentType = resp.headers.get('content-type') || '';
        if (!resp.ok) {
          let message = `HTTP ${resp.status}`;
          if (contentType.includes('application/json')) {
            const data = await resp.json().catch(()=>null);
            if (data && (data.message || data.error)) message += `: ${data.message||data.error}`;
          } else {
            const text = await resp.text().catch(()=>null);
            if (text) message += `: ${text}`;
          }
          throw new Error(message);
        }
        if (contentType.includes('application/json')) return resp.json();
        return resp.text();
      }

      function AgentApp() {
        const [token, setToken] = useState(localStorage.getItem('token') || '');
        const [interventions, setInterventions] = useState([]);
        const [selected, setSelected] = useState(null);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [success, setSuccess] = useState('');

        const API = getApiBase();

        useEffect(() => {
          if (!token) {
            setError('Token manquant. Veuillez vous connecter.');
            return;
          }
          loadInterventions();
        }, [token]);

        async function loadInterventions() {
          setLoading(true); setError('');
          try {
            let cin = null;
            try {
              const me = await fetchJSON(`${API}/agents/me`, { headers: { Authorization: `Bearer ${token}` } });
              cin = (me && (me.cin || me.cinAgent || me.cin_agent)) || null;
            } catch (e) {}

            let data;
            if (cin) {
              data = await fetchJSON(`${API}/interventions/agent/${cin}`, { headers: { Authorization: `Bearer ${token}` } });
            } else {
              data = await fetchJSON(`${API}/interventions`, { headers: { Authorization: `Bearer ${token}` } });
            }

            const list = Array.isArray(data) ? data : (data && data.content) || [];
            const filtered = cin ? list.filter(i => `${i.cinAgent}` === `${cin}`) : list;
            setInterventions(filtered);
            if (!selected && filtered.length > 0) setSelected(filtered[0]);
          } catch (e) {
            setError(e.message || String(e));
          } finally {
            setLoading(false);
          }
        }

        async function updateEtat(interventionId, newEtat) {
          setError(''); setSuccess('');
          try {
            await fetchJSON(`${API}/interventions/${interventionId}/etat`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`
              },
              body: JSON.stringify({ etat: Number(newEtat) })
            });
            setSuccess('État mis à jour avec succès');
            await loadInterventions();
            if (selected) {
              const updated = (interventions || []).find(i => i.id === interventionId) || selected;
              setSelected(updated);
            }
          } catch (e) {
            setError(e.message || String(e));
          }
        }

        return (
          <div className="container">
            <div className="header">
              <div className="title">Espace Agent - Mes interventions</div>
              <div className="muted">Connecté {token ? '✅' : '❌'}</div>
            </div>

            {error && <div className="error">{error}</div>}
            {success && <div className="success">{success}</div>}

            <div className="row">
              <div className="panel">
                <div className="muted" style={{ marginBottom: 8 }}>Sélectionnez une intervention</div>
                <div className="list">
                  {(interventions||[]).map(i => (
                    <div key={i.id} className="item">
                      <div>
                        <div><strong>#{i.id}</strong> · {i.type} · Urgence: {i.urgence}</div>
                        <div className="muted">Budget: {i.budget} · Début: {i.dateDebut}</div>
                      </div>
                      <button className="btn" onClick={() => setSelected(i)}>Voir</button>
                    </div>
                  ))}
                  {(!interventions || interventions.length === 0) && (
                    <div className="muted">Aucune intervention assignée.</div>
                  )}
                </div>
              </div>

              <div className="panel">
                <div className="title" style={{ marginBottom: 8 }}>Détails</div>
                {!selected && <div className="muted">Sélectionnez une intervention à droite.</div>}
                {selected && (
                  <div>
                    <div className="detail-row"><span>Id</span><span>{selected.id}</span></div>
                    <div className="detail-row"><span>Type</span><span>{selected.type}</span></div>
                    <div className="detail-row"><span>Urgence</span><span>{selected.urgence}</span></div>
                    <div className="detail-row"><span>Budget</span><span>{selected.budget}</span></div>
                    <div className="detail-row"><span>Date de début</span><span>{selected.dateDebut}</span></div>
                    <div className="detail-row"><span>Localisation</span><span>{selected.localisation}</span></div>
                    <div className="detail-row"><span>CIN Agent</span><span>{selected.cinAgent}</span></div>
                    <div className="detail-row"><span>État</span>
                      <span>
                        <input className="input" type="number" min="0" max="10" value={selected.etat !== undefined && selected.etat !== null ? selected.etat : 0}
                          onChange={(e) => setSelected({ ...selected, etat: Number(e.target.value) })} />
                      </span>
                    </div>
                    <div style={{ display: 'flex', gap: 8, marginTop: 12 }}>
                      <button className="btn btn-primary" onClick={() => updateEtat(selected.id, selected.etat)}>Enregistrer l'état</button>
                    </div>
                  </div>
                )}
              </div>
            </div>

          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<AgentApp />);
    </script>
  </body>
</html>
